@model List<Remember.Domain.CardBox>

@{
    Layout = null;
    ViewBag.Title = "卡片盒列表";
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>@ViewBag.Title</title>
    <link href="~/dist/layui/css/layui.css" rel="stylesheet" />
</head>
<body>
    @if (TempData["message"] != null)
    {
        <div>@TempData["message"]</div>
    }
    <h2 style="text-align: center;">@ViewBag.Title</h2>
    <p>
        <button class="layui-btn layui-btn-sm" onclick="onAdd()">新增</button>
    </p>
    <table class="layui-table" lay-size="sm">
        <colgroup>
            <col width="10">
            <col width="10">
            <col width="10">
            <col width="10">
            <col width="100">
        </colgroup>
        <thead>
            <tr>
                <th>ID</th>
                <th>盒名</th>
                <th>描述</th>
                <th>创建者</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
            <tr>
                <td>
                    @Html.DisplayFor(modelItem => item.ID)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Name)
                </td>
                <td>
                    @Html.Raw(item.Description).ToHtmlString().Substring(0, item.Description.Length > 8 ? 8 : item.Description.Length)@(item.Description.Length > 8 ? "..." : "")
                </td>
                <td>
                    昵称:@Html.DisplayFor(modelItem => item.Creator.Name)<br />
                    账号:@Html.DisplayFor(modelItem => item.Creator.LoginAccount)
                </td>
                <td>
                    <button class="layui-btn layui-btn-sm" onclick="onEdit(@item.ID)">修改</button>
                    <button class="layui-btn layui-btn-sm" onclick="onDetails(@item.ID)">查看</button>
                    <button class="layui-btn layui-btn-sm" onclick="onDelete(@item.ID)">删除</button>
                    @Html.ActionLink("查看卡片", "Index", "CardInfo", new { cardBoxId = item.ID }, new { @class = "layui-btn layui-btn-sm", target = "_blank" })
                </td>
            </tr>
            }
        </tbody>
    </table>
    <div id="js-page-bar"></div>
    <script src="~/dist/layui/layui.js"></script>
    <script src="~/dist/jquery/jquery-3.3.1.min.js"></script>
    <script>
    // start 分页
    layui.use(['laypage', 'layer'], function () {
        laypage = layui.laypage
        , layer = layui.layer;
        laypage.render({
            elem: 'js-page-bar'
            , count: @ViewBag.TotalCount
            , layout: ['count', 'prev', 'page', 'next', 'refresh', 'skip']
            , curr: @ViewBag.PageIndex
            , jump: function (obj, isFirstLoad) {
                console.log(obj, isFirstLoad);
                if (!isFirstLoad) {
                    pageGo(obj.curr, obj.limit);
                }
            }
        });
    });

    function pageGo(pageIndex, pageSize) {
        window.location.href = '@Url.Action("Index")?pageIndex=' + pageIndex;
    }
    // end 分页

    // start 操作
    function onAdd() {
        layer.open({
            type: 2,
            closeBtn: 1,
            anim: 4,
            title: "新增",
            shade: 0.4,
            shadeClose: false,
            area: ['500px', '440px'],
            content: ['/Admin/CardBox/Create', 'yes'],
            end: function () {
                location.href = location.href; // 刷新页面
            }
        });
    }
    function onEdit(id) {
        layer.open({
            type: 2,
            closeBtn: 1,
            anim: 4,
            title: "修改",
            shade: 0.4,
            shadeClose: false,
            area: ['500px', '440px'],
            content: ['/Admin/CardBox/Edit?id=' + id, 'yes'],
            end: function () {
                location.href = location.href; // 刷新页面
            }
        });
    }
    function onDetails(id) {
        layer.open({
            type: 2,
            closeBtn: 1,
            anim: 4,
            title: "查看",
            shade: 0.4,
            shadeClose: false,
            area: ['500px', '440px'],
            content: ['/Admin/CardBox/Details?id=' + id, 'yes'],
        });
    }
    function onDelete(id) {
        if (confirm('您确认要删除吗？')) {
            // 删除
            $.ajax({
                type: "post",
                url: "/Admin/CardBox/Delete",
                data: { id: id },
                dataType: "json",
                success: function (data) {
                    if (data.code == 1) {
                        // 提交成功
                        // 刷新列表
                        location.href = location.href;
                    } else if (data.code == -1) {
                        layer.msg(data.message);
                    }
                }
            });
        }
    }
    // end 操作
    function showMsg(msg) {
        layer.msg(msg);
    }

    // 失败 layui, layer 没有被定义
    @*showMsg('测额');
    @if (TempData["message"] != null)
    {
        @Html.Raw("layui.use(['laypage', 'layer'], function () { layer = layui.layer; });")
        @Html.Raw("console.log(layui);")
        @Html.Raw("showMsg('" + TempData["message"] + "')");
    }*@
    </script>
    @*@if (TempData["message"] != null)
    {
        <script>
            window.layer.msg('@TempData["message"]');
        </script>
    }*@
</body>
</html>
