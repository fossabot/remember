@model List<Remember.Domain.CardInfo>

@{
    Layout = null;
    ViewBag.Title = "卡片列表";
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>@ViewBag.Title</title>
    <link href="~/dist/layui/css/layui.css" rel="stylesheet" />
</head>
<body>
    @if (TempData["message"] != null)
    {
        <div>@TempData["message"]</div>
    }
    <h2 style="text-align: center;">@ViewBag.Title</h2>
    <div class="layui-fluid">
        <div class="layui-row">
            <div class="layui-col-xs8">
                <button class="layui-btn layui-btn-sm" onclick="onAdd()">新增</button>
            </div>
        </div>
        <div class="layui-row">
            <div class="layui-col-xs8">
                <form class="layui-form" method="get">
                    <div class="layui-form-item">
                        @Html.Label("卡片内容关键词", new { @class = "layui-form-label" })
                        <div class="layui-input-inline">
                            @* 意外发现：使用HtmlHelper 当 name 存在于 对应Action的参数列表时，则会自动将其参数值放入input.value *@
                            @Html.TextBox("keyword", null, new { @class = "layui-input" })
                        </div>
                        <input class="layui-btn layui-btn-sm" type="submit" value="搜索" />
                    </div>
                </form>
            </div>
        </div>
    </div>
    <table class="layui-table" lay-size="sm">
        <colgroup>
            <col width="10">
            <col width="10">
            <col width="10">
            <col width="100">
        </colgroup>
        <thead>
            <tr>
                <th>ID</th>
                <th>卡片盒</th>
                <th>内容</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>
                        @Html.DisplayFor(modelItem => item.ID)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.CardBox.ID) : @Html.DisplayFor(modelItem => item.CardBox.Name)
                    </td>
                    <td>
                        @Html.Raw(item.Content).ToHtmlString().Substring(0, item.Content.Length > 8 ? 8 : item.Content.Length)@(item.Content.Length > 8 ? "..." : "")
                    </td>
                    <td>
                        <button class="layui-btn layui-btn-sm" onclick="onEdit(@item.ID)">修改</button>
                        <button class="layui-btn layui-btn-sm" onclick="onDetails(@item.ID)">查看</button>
                        <button class="layui-btn layui-btn-sm" onclick="onDelete(@item.ID)">删除</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
    <div id="js-page-bar"></div>
    <script src="~/dist/layui/layui.js"></script>
    <script src="~/dist/jquery/jquery-3.3.1.min.js"></script>
    <script>
        // start 分页
        layui.use(['laypage', 'layer'], function () {
            laypage = layui.laypage
            , layer = layui.layer;
            laypage.render({
                elem: 'js-page-bar'
                , count: @ViewBag.TotalCount
                , layout: ['count', 'prev', 'page', 'next', 'refresh', 'skip']
                , curr: @ViewBag.PageIndex
                , limit: @ViewBag.PageSize
                , jump: function (obj, isFirstLoad) {
                    console.log(obj, isFirstLoad);
                    if (!isFirstLoad) {
                        pageGo(obj.curr, obj.limit);
                    }
                }
            });
        });

        function pageGo(pageIndex, pageSize) {
            window.location.href = '@Url.Action("Index")?pageIndex=' + pageIndex + '&keyword=' + $('input[name="keyword"]').val();
        }
        // end 分页

        // start 操作
        function onAdd() {
            layer.open({
                type: 2,
                closeBtn: 1,
                anim: 4,
                title: "新增",
                shade: 0.4,
                shadeClose: false,
                area: ['500px', '300px'],
                maxmin: true,
                content: ['/CardInfo/Create', 'yes'],
                end: function () {
                    location.href = location.href; // 刷新页面
                }
            });
        }
        function onEdit(id) {
            layer.open({
                type: 2,
                closeBtn: 1,
                anim: 4,
                title: "修改",
                shade: 0.4,
                shadeClose: false,
                area: ['500px', '300px'],
                maxmin: true,
                content: ['/CardInfo/Edit?id=' + id, 'yes'],
                end: function () {
                    location.href = location.href; // 刷新页面
                }
            });
        }
        function onDetails(id) {
            layer.open({
                type: 2,
                closeBtn: 1,
                anim: 4,
                title: "查看",
                shade: 0.4,
                shadeClose: false,
                area: ['500px', '300px'],
                maxmin: true,
                content: ['/CardInfo/Details?id=' + id, 'yes'],
            });
        }
        function onDelete(id) {
            if (confirm('您确认要删除吗？')) {
                // 删除
                $.ajax({
                    type: "post",
                    url: "/CardInfo/Delete",
                    data: { id: id },
                    dataType: "json",
                    success: function (data) {
                        if (data.code == 1) {
                            // 提交成功
                            // 刷新列表
                            location.href = location.href;
                        } else if (data.code == -1) {
                            layer.msg(data.message);
                        }
                    }
                });
            }
        }
        // end 操作

        // 取url?参数
        function getQueryString(name) { 
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i"); 
            var r = window.location.search.substr(1).match(reg); 
            if (r != null) return unescape(r[2]); 
            return null; 
        } 
    </script>
</body>
</html>
